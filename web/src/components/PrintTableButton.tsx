import React, { useCallback, useRef, useState } from 'react';                                                                                                                                                                                                        
  import ReactDOMServer from 'react-dom/server';                                                                                                                                                                                                                       
  import styled from 'styled-components';                                                                                                                                                                                                                              
  import { Item } from '../types';                                                                                                                                                                                                                                     
  import { getFormattedCode } from '../utils/codeMapping';                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                       
  const PrintButton = styled.button`                                                                                                                                                                                                                                   
    width: 100%;                                                                                                                                                                                                                                                       
    padding: ${({ theme }) => theme.spacing.medium};                                                                                                                                                                                                                   
    background-color: ${({ theme }) => theme.colors.primary};
    color: ${({ theme }) => theme.colors.white};                                                                                                                                                                                                                       
    border: none;                                                                                                                                                                                                                                                      
    border-radius: ${({ theme }) => theme.borderRadius};                                                                                                                                                                                                               
    font-size: 1rem;                                                                                                                                                                                                                                                   
    transition: background-color 0.2s;                                                                                                                                                                                                                                 
    display: flex;                                                                                                                                                                                                                                                     
    align-items: center;                                                                                                                                                                                                                                               
    justify-content: center;                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                       
    &:hover:not(:disabled) {                                                                                                                                                                                                                                           
      background-color: ${({ theme }) => theme.colors.primaryDark};                                                                                                                                                                                                    
    }                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                       
    &:disabled {                                                                                                                                                                                                                                                       
      background-color: ${({ theme }) => theme.colors.disabled};                                                                                                                                                                                                       
      cursor: not-allowed;                                                                                                                                                                                                                                             
    }                                                                                                                                                                                                                                                                  
  `;                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                       
  const getDisplayNameForUser = (item: Item): string => {                                                                                                                                                                                                              
    if (!item.createdBy) return 'Nepoznato';                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                       
    if (                                                                                                                                                                                                                                                               
      item.createdBy.email === 'vetovo.vaga@velicki-kamen.hr' ||                                                                                                                                                                                                       
      item.createdBy.email === 'velicki.vaga@velicki-kamen.hr'                                                                                                                                                                                                         
    ) {                                                                                                                                                                                                                                                                
      return 'VELIÄŒKI KAMEN d.o.o.';                                                                                                                                                                                                                                  
    }                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                       
    if (item.createdBy.email === 'vaga.fukinac@kamen-psunj.hr') {
      return 'KAMEN - PSUNJ d.o.o.';                                                                                                                                                                                                                                   
    }                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                       
    if (item.createdBy.email === 'vaga.molaris@osijek-koteks.hr') {                                                                                                                                                                                                    
      return 'MOLARIS d.o.o.';                                                                                                                                                                                                                                         
    }                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                       
    return `${item.createdBy.firstName} ${item.createdBy.lastName}`;
  };                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                       
  // Robust date formatting for print - always returns DD.MM.YYYY                                                                                                                                                                                                      
  const safeParseDate = (dateInput: any): string => {                                                                                                                                                                                                                  
    if (!dateInput) return 'N/A';                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                       
    try {                                                                                                                                                                                                                                                              
      // Handle MongoDB date objects with $date property                                                                                                                                                                                                               
      if (typeof dateInput === 'object' && dateInput.$date) {                                                                                                                                                                                                          
        const date = new Date(dateInput.$date);                                                                                                                                                                                                                        
        if (isNaN(date.getTime())) {                                                                                                                                                                                                                                   
          return String(dateInput.$date);                                                                                                                                                                                                                              
        }                                                                                                                                                                                                                                                              
        return date.toLocaleDateString('hr-HR', {                                                                                                                                                                                                                      
          day: '2-digit',                                                                                                                                                                                                                                              
          month: '2-digit',                                                                                                                                                                                                                                            
          year: 'numeric',                                                                                                                                                                                                                                             
          timeZone: 'Europe/Zagreb',                                                                                                                                                                                                                                   
        });                                                                                                                                                                                                                                                            
      }                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                       
      // Handle Date objects                                                                                                                                                                                                                                           
      if (dateInput instanceof Date) {                                                                                                                                                                                                                                 
        if (isNaN(dateInput.getTime())) {                                                                                                                                                                                                                              
          return String(dateInput);                                                                                                                                                                                                                                    
        }                                                                                                                                                                                                                                                              
        return dateInput.toLocaleDateString('hr-HR', {                                                                                                                                                                                                                 
          day: '2-digit',                                                                                                                                                                                                                                              
          month: '2-digit',                                                                                                                                                                                                                                            
          year: 'numeric',                                                                                                                                                                                                                                             
          timeZone: 'Europe/Zagreb',                                                                                                                                                                                                                                   
        });                                                                                                                                                                                                                                                            
      }                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                       
      // Handle string inputs                                                                                                                                                                                                                                          
      if (typeof dateInput === 'string') {                                                                                                                                                                                                                             
        const dateStr = dateInput.trim();                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                       
        // Croatian format with spaces and optional trailing period:                                                                                                                                                                                                   
        // "04. 09. 2025.", "04. 09. 2025", "4. 9. 2025." etc.                                                                                                                                                                                                         
        const croatianWithSpacesMatch = dateStr.match(                                                                                                                                                                                                                 
          /^(\d{1,2})\.\s*(\d{1,2})\.\s*(\d{4})\.?$/                                                                                                                                                                                                                   
        );                                                                                                                                                                                                                                                             
        if (croatianWithSpacesMatch) {                                                                                                                                                                                                                                 
          const [, day, month, year] = croatianWithSpacesMatch;                                                                                                                                                                                                        
          return `${day.padStart(2, '0')}.${month.padStart(2, '0')}.${year}`;                                                                                                                                                                                          
        }                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                       
        // Standard Croatian format without spaces: "DD.MM.YYYY"                                                                                                                                                                                                       
        const croatianStandardMatch = dateStr.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);                                                                                                                                                                                
        if (croatianStandardMatch) {                                                                                                                                                                                                                                   
          const [, day, month, year] = croatianStandardMatch;                                                                                                                                                                                                          
          return `${day.padStart(2, '0')}.${month.padStart(2, '0')}.${year}`;
        }                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                       
        // dd/MM/yyyy -> normalize to dd.MM.yyyy (treat first as day)                                                                                                                                                                                                  
        const croatianSlashMatch = dateStr.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);                                                                                                                                                                                   
        if (croatianSlashMatch) {                                                                                                                                                                                                                                      
          const [, day, month, year] = croatianSlashMatch;                                                                                                                                                                                                             
          return `${day.padStart(2, '0')}.${month.padStart(2, '0')}.${year}`;                                                                                                                                                                                          
        }                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                       
        // For ISO strings or other date formats, parse them safely                                                                                                                                                                                                    
        const date = new Date(dateStr);                                                                                                                                                                                                                                
        if (!isNaN(date.getTime())) {                                                                                                                                                                                                                                  
          return date.toLocaleDateString('hr-HR', {                                                                                                                                                                                                                    
            day: '2-digit',                                                                                                                                                                                                                                            
            month: '2-digit',                                                                                                                                                                                                                                          
            year: 'numeric',                                                                                                                                                                                                                                           
            timeZone: 'Europe/Zagreb',                                                                                                                                                                                                                                 
          });                                                                                                                                                                                                                                                          
        }                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                       
        // If all parsing fails, return original string                                                                                                                                                                                                                
        console.warn('Could not parse date:', dateStr);                                                                                                                                                                                                                
        return dateStr;                                                                                                                                                                                                                                                
      }                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                       
      // Handle any other type                                                                                                                                                                                                                                         
      const date = new Date(String(dateInput));                                                                                                                                                                                                                        
      if (!isNaN(date.getTime())) {                                                                                                                                                                                                                                    
        return date.toLocaleDateString('hr-HR', {                                                                                                                                                                                                                      
          day: '2-digit',                                                                                                                                                                                                                                              
          month: '2-digit',                                                                                                                                                                                                                                            
          year: 'numeric',                                                                                                                                                                                                                                             
          timeZone: 'Europe/Zagreb',                                                                                                                                                                                                                                   
        });                                                                                                                                                                                                                                                            
      }                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                       
      console.warn('Failed to parse date input:', dateInput);                                                                                                                                                                                                          
      return String(dateInput);                                                                                                                                                                                                                                        
    } catch (error) {                                                                                                                                                                                                                                                  
      console.error('Error in safeParseDate:', error, 'Input:', dateInput);                                                                                                                                                                                            
      return String(dateInput);                                                                                                                                                                                                                                        
    }                                                                                                                                                                                                                                                                  
  };                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                       
  const formatDateAndTime = (creationDate: any, creationTime?: string): string => {                                                                                                                                                                                    
    const formattedDate = safeParseDate(creationDate);
                                                                                                                                                                                                                                                                       
    if (!formattedDate || formattedDate === 'N/A') {                                                                                                                                                                                                                   
      console.warn('formatDateAndTime - failed to format date:', creationDate);                                                                                                                                                                                        
      const fallback = String(creationDate);                                                                                                                                                                                                                           
      return creationTime ? `${fallback} ${creationTime}` : fallback;                                                                                                                                                                                                  
    }                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                       
    return creationTime ? `${formattedDate} ${creationTime}` : formattedDate;                                                                                                                                                                                          
  };                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                       
  const formatApprovalDate = (approvalDate: any): string => {                                                                                                                                                                                                          
    if (!approvalDate) return '-';                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                       
    let date: Date;                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                       
    try {                                                                                                                                                                                                                                                              
      if (typeof approvalDate === 'object' && approvalDate.$date) {                                                                                                                                                                                                    
        date = new Date(approvalDate.$date);                                                                                                                                                                                                                           
      } else if (typeof approvalDate === 'string') {                                                                                                                                                                                                                   
        // If it's already formatted Croatian datetime (DD.MM.YYYY HH:MM), return as is                                                                                                                                                                                
        if (approvalDate.match(/^\d{1,2}\.\d{1,2}\.\d{4} \d{1,2}:\d{2}$/)) {                                                                                                                                                                                           
          return approvalDate;                                                                                                                                                                                                                                         
        }                                                                                                                                                                                                                                                              
        date = new Date(approvalDate);                                                                                                                                                                                                                                 
      } else {                                                                                                                                                                                                                                                         
        date = new Date(approvalDate);                                                                                                                                                                                                                                 
      }                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                       
      if (isNaN(date.getTime())) {                                                                                                                                                                                                                                     
        return String(approvalDate);                                                                                                                                                                                                                                   
      }                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                       
      return date.toLocaleString('hr-HR', {                                                                                                                                                                                                                            
        day: '2-digit',                                                                                                                                                                                                                                                
        month: '2-digit',                                                                                                                                                                                                                                              
        year: 'numeric',                                                                                                                                                                                                                                               
        hour: '2-digit',                                                                                                                                                                                                                                               
        minute: '2-digit',                                                                                                                                                                                                                                             
        timeZone: 'Europe/Zagreb',                                                                                                                                                                                                                                     
      });                                                                                                                                                                                                                                                              
    } catch (error) {                                                                                                                                                                                                                                                  
      console.error('Error formatting approval date:', approvalDate, error);                                                                                                                                                                                           
      return String(approvalDate);                                                                                                                                                                                                                                     
    }                                                                                                                                                                                                                                                                  
  };                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                       
  // PrintableTable component with fixed date formatting                                                                                                                                                                                                               
  const PrintableTable = ({ items, dateRange }: { items: Item[]; dateRange?: string }) => {                                                                                                                                                                            
    return (                                                                                                                                                                                                                                                           
      <div className="print-container">                                                                                                                                                                                                                                
        <div className="print-header">                                                                                                                                                                                                                                 
          <img src="/images/logo.png" alt="Osijek-Koteks Logo" className="print-logo" />                                                                                                                                                                               
          <div className="company-info">                                                                                                                                                                                                                               
            <p>Osijek-Koteks d.d.</p>                                                                                                                                                                                                                                  
            <p>Å amaÄka 11, 31000 Osijek, Hrvatska</p>                                                                                                                                                                                                                
            <p>Tel: +385 31 227 700 | Fax: +385 31 227 777</p>                                                                                                                                                                                                         
            <p>Email: info@osijek-koteks.hr | Web: www.osijek-koteks.hr</p>                                                                                                                                                                                            
          </div>                                                                                                                                                                                                                                                       
                                                                                                                                                                                                               
          {dateRange && <p className="print-date-range">Period: {dateRange}</p>}                                                                                                                                                                                       
          <p className="print-date">                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                    
          </p>                                                                                                                                                                                                                                                         
        </div>                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                       
        <table className="print-table">                                                                                                                                                                                                                                
          <thead>                                                                                                                                                                                                                                                      
            <tr>
              <th>Broj otpremnice</th>
              <th>Radni nalog</th>
              <th>DobavljaÄ</th>
              <th>Prijevoznik</th>
              <th>Registracija</th>
              <th>TeÅ¾ina (t)</th>
              <th>Razlika u vaganju (%)</th>
              <th>Datum kreiranja</th>
              <th>Status</th>
              <th>PlaÄ‡eno</th>
              <th>Odobrio</th>
              <th>Datum odobrenja</th>
            </tr>
          </thead>
          <tbody>
            {items.map((item: Item, index: number) => (                                                                                                                                                                                                                
              <tr key={item._id}>                                                                                                                                                                                                                                      
                <td>{item.title}</td>                                                                                                                                                                                                                                  
                <td>{getFormattedCode(item.code)}</td>                                                                                                                                                                                                                 
                <td>{getDisplayNameForUser(item)}</td>                                                                                                                                                                                                                 
                <td>{item.prijevoznik || '-'}</td>
                <td>{item.registracija || '-'}</td>
                <td>{item.tezina !== undefined ? (item.tezina / 1000).toFixed(3) : '-'}</td>
                <td>
                  {item.approvalStatus === 'odobreno' && item.neto !== undefined
                    ? item.neto > 1000                                                                                                                                                                                                                                 
                      ? '/'                                                                                                                                                                                                                                            
                      : `${item.neto}%`                                                                                                                                                                                                                                
                    : '-'}                                                                                                                                                                                                                                             
                </td>
                <td>{formatDateAndTime(item.creationDate, item.creationTime)}</td>
                <td>{item.approvalStatus}</td>
                <td>{item.isPaid ? 'Da' : 'Ne'}</td>
                <td>
                  {item.approvedBy ? `${item.approvedBy.firstName} ${item.approvedBy.lastName}` : '-'}
                </td>
                <td>{formatApprovalDate(item.approvalDate)}</td>
              </tr>
            ))}                                                                                                                                                                                                                                                        
          </tbody>                                                                                                                                                                                                                                                     
        </table>                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                       
        <style>                                                                                                                                                                                                                                                        
          {`                                                                                                                                                                                                                                                           
            .print-container {                                                                                                                                                                                                                                         
              padding: 20px;                                                                                                                                                                                                                                           
              font-family: Arial, sans-serif;                                                                                                                                                                                                                          
              color: #000;                                                                                                                                                                                                                                             
            }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                       
            .print-header {                                                                                                                                                                                                                                            
              display: flex;                                                                                                                                                                                                                                           
              align-items: center;                                                                                                                                                                                                                                     
              margin-bottom: 20px;                                                                                                                                                                                                                                     
              border-bottom: 2px solid #000;                                                                                                                                                                                                                           
              padding-bottom: 10px;                                                                                                                                                                                                                                    
            }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                       
            .print-logo {                                                                                                                                                                                                                                              
              height: 60px;                                                                                                                                                                                                                                            
              margin-right: 20px;                                                                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                       
            .company-info {                                                                                                                                                                                                                                            
              flex: 1;                                                                                                                                                                                                                                                 
              font-size: 12px;                                                                                                                                                                                                                                         
            }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                       
            .company-info p {                                                                                                                                                                                                                                          
              margin: 2px 0;                                                                                                                                                                                                                                           
            }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                       
            .print-title {                                                                                                                                                                                                                                             
              font-size: 24px;                                                                                                                                                                                                                                         
              margin: 0;                                                                                                                                                                                                                                               
              text-align: right;                                                                                                                                                                                                                                       
            }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                       
            .print-date-range {                                                                                                                                                                                                                                        
              margin-top: 5px;                                                                                                                                                                                                                                         
              font-size: 12px;                                                                                                                                                                                                                                         
              text-align: right;                                                                                                                                                                                                                                       
            }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                       
            .print-date {                                                                                                                                                                                                                                              
              margin-top: 5px;                                                                                                                                                                                                                                         
              font-size: 12px;                                                                                                                                                                                                                                         
              text-align: right;                                                                                                                                                                                                                                       
            }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                       
            .print-table {
              width: 100%;
              border-collapse: collapse;
              margin-top: 20px;
              font-size: 8px;        /* tighter text */
            }

            .print-table th,
            .print-table td {
              border: 1px solid #000;
              padding: 1px 2px;      /* much tighter padding for shorter rows */
              text-align: left;
              line-height: 1.0;
            }

            .print-table th {
              background-color: #f0f0f0;
              font-size: 8px;
              font-weight: 600;
            }
            .print-table th:nth-child(1),
            .print-table td:nth-child(1) { width: 10%; } /* Broj otpremnice */
            .print-table th:nth-child(2),
            .print-table td:nth-child(2) { width: 10%; } /* Radni nalog */
            .print-table th:nth-child(3),
            .print-table td:nth-child(3) { width: 12%; } /* DobavljaÄ */
            .print-table th:nth-child(4),
            .print-table td:nth-child(4) { width: 10%; } /* Prijevoznik */
            .print-table th:nth-child(5),
            .print-table td:nth-child(5) { width: 9%; }  /* Registracija */
            .print-table th:nth-child(6),
            .print-table td:nth-child(6) { width: 7%; }  /* TeÅ¾ina */
            .print-table th:nth-child(7),
            .print-table td:nth-child(7) { width: 8%; }  /* Razlika u vaganju */
            .print-table th:nth-child(8),
            .print-table td:nth-child(8) { width: 11%; } /* Datum kreiranja */
            .print-table th:nth-child(9),
            .print-table td:nth-child(9) { width: 7%; }  /* Status */
            .print-table th:nth-child(10),
            .print-table td:nth-child(10) { width: 6%; } /* PlaÄ‡eno */
            .print-table th:nth-child(11),
            .print-table td:nth-child(11) { width: 8%; } /* Odobrio */
            .print-table th:nth-child(12),
            .print-table td:nth-child(12) { width: 8%; } /* Datum odobrenja */
                                                                                                                                                                                                                                                                       
            .print-footer {                                                                                                                                                                                                                                            
              margin-top: 15px;                                                                                                                                                                                                                                        
              text-align: center;                                                                                                                                                                                                                                      
              font-size: 9px;                                                                                                                                                                                                                                          
              color: #666;                                                                                                                                                                                                                                             
            }                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                       
            @page {                                                                                                                                                                                                                                                    
              size: landscape;                                                                                                                                                                                                                                         
              margin: 0.5cm;                                                                                                                                                                                                                                           
            }                                                                                                                                                                                                                                                          
          `}
        </style>                                                                                                                                                                                                                                                       
      </div>                                                                                                                                                                                                                                                           
    );                                                                                                                                                                                                                                                                 
  };                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                       
  // Updated interface to handle both a single item or an array of items                                                                                                                                                                                               
  interface PrintTableButtonProps {                                                                                                                                                                                                                                    
    items?: Item[];                                                                                                                                                                                                                                                    
    item?: Item;
    totalItems?: number;                                                                                                                                                                                                                                               
    totalWeight?: number;                                                                                                                                                                                                                                              
    isLoading?: boolean;                                                                                                                                                                                                                                               
    onPrintAll?: () => Promise<Item[]>;                                                                                                                                                                                                                                
    dateRange?: string;                                                                                                                                                                                                                                                
  }                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                       
  const PrintTableButton: React.FC<PrintTableButtonProps> = ({                                                                                                                                                                                                         
    items,                                                                                                                                                                                                                                                             
    item,                                                                                                                                                                                                                                                              
    totalItems = 0,                                                                                                                                                                                                                                                    
    totalWeight,                                                                                                                                                                                                                                                       
    isLoading = false,                                                                                                                                                                                                                                                 
    onPrintAll,                                                                                                                                                                                                                                                        
    dateRange,                                                                                                                                                                                                                                                         
  }) => {                                                                                                                                                                                                                                                              
    const [isPrinting, setIsPrinting] = useState(false);                                                                                                                                                                                                               
    const printContainerRef = useRef<HTMLDivElement>(null);                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                       
    // Convert single item to array if needed                                                                                                                                                                                                                          
    const itemsToDisplay = item ? [item] : items || [];                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                       
    const handlePrint = useCallback(async () => {                                                                                                                                                                                                                      
      if (!itemsToDisplay.length && totalItems === 0) return;                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                       
      try {                                                                                                                                                                                                                                                            
        setIsPrinting(true);                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                       
        let allItems = itemsToDisplay;                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                       
        // If we need to fetch all items for printing                                                                                                                                                                                                                  
        if (onPrintAll && totalItems > itemsToDisplay.length) {                                                                                                                                                                                                        
          try {                                                                                                                                                                                                                                                        
            allItems = await onPrintAll();                                                                                                                                                                                                                             
          } catch (error) {                                                                                                                                                                                                                                            
            console.error('Error fetching all items for printing:', error);                                                                                                                                                                                            
            alert('GreÅ¡ka pri dohvaÄ‡anju svih dokumenata za ispis');                                                                                                                                                                                              
            return;                                                                                                                                                                                                                                                    
          }                                                                                                                                                                                                                                                            
        }                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                       
        const printWindow = window.open('', '_blank');                                                                                                                                                                                                                 
        if (!printWindow) {                                                                                                                                                                                                                                            
          alert('Morate omoguÄ‡iti pop-up prozore za ispis');                                                                                                                                                                                                       
          return;                                                                                                                                                                                                                                                      
        }                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                       
        // Generate the printable table HTML                                                                                                                                                                                                                           
        const printableTableHtml = ReactDOMServer.renderToString(                                                                                                                                                                                                      
          <PrintableTable items={allItems} dateRange={dateRange} />                                                                                                                                                                                                    
        );                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                       
        // Generate total weight summary if available                                                                                                                                                                                                                  
        const totalWeightSummaryHtml = totalWeight                                                                                                                                                                                                                     
          ? `                                                                                                                                                                                                                                                          
          <div style="                                                                                                                                                                                                                                                 
            margin-top: 20px;                                                                                                                                                                                                                                          
            padding: 15px;                                                                                                                                                                                                                                             
            background-color: #f8f9fa;                                                                                                                                                                                                                                 
            border: 1px solid #dee2e6;                                                                                                                                                                                                                                 
            border-radius: 5px;                                                                                                                                                                                                                                        
            text-align: center;                                                                                                                                                                                                                                        
          ">                                                                                                                                                                                                                                                           
            <div style="                                                                                                                                                                                                                                               
              font-size: 14px;                                                                                                                                                                                                                                         
              font-weight: bold;                                                                                                                                                                                                                                       
              color: #333;                                                                                                                                                                                                                                             
              margin-bottom: 5px;                                                                                                                                                                                                                                      
            ">                                                                                                                                                                                                                                                         
              Ukupna teÅ¾iina: ${(totalWeight / 1000).toFixed(3)} t                                                                                                                                                                                                     
            </div>                                                                                                                                                                                                                                                     
            <div style="                                                                                                                                                                                                                                               
              font-size: 12px;                                                                                                                                                                                                                                         
              color: #666;                                                                                                                                                                                                                                             
            ">                                                                                                                                                                                                                                                         
              Ukupno ${allItems.length} ${                                                                                                                                                                                                                             
                allItems.length === 1 ? 'kamion' : allItems.length < 5 ? 'kamiona' : 'kamiona'                                                                                                                                                                         
              }                                                                                                                                                                                                                                                        
            </div>                                                                                                                                                                                                                                                     
            <div style="                                                                                                                                                                                                                                               
              font-size: 10px;                                                                                                                                                                                                                                         
              color: #666;                                                                                                                                                                                                                                             
              margin-top: 5px;                                                                                                                                                                                                                                         
            ">                                                                                                                                                                                                                                                         
              Datum ispisa: ${new Date().toLocaleDateString('hr-HR', {                                                                                                                                                                                                 
                day: '2-digit',                                                                                                                                                                                                                                        
                month: '2-digit',                                                                                                                                                                                                                                      
                year: 'numeric',                                                                                                                                                                                                                                       
                hour: '2-digit',                                                                                                                                                                                                                                       
                minute: '2-digit',                                                                                                                                                                                                                                     
              })}                                                                                                                                                                                                                                                      
            </div>                                                                                                                                                                                                                                                     
          </div>                                                                                                                                                                                                                                                       
        `                                                                                                                                                                                                                                                              
          : '';                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                       
        const printContent = `                                                                                                                                                                                                                                         
          <!DOCTYPE html>                                                                                                                                                                                                                                              
          <html>                                                                                                                                                                                                                                                       
            <head>                                                                                                                                                                                                                                                     
              <title>Pregled dokumenata - Ispis</title>                                                                                                                                                                                                                
              <style>                                                                                                                                                                                                                                                  
                @media print {                                                                                                                                                                                                                                         
                  * {                                                                                                                                                                                                                                                  
                    -webkit-print-color-adjust: exact !important;                                                                                                                                                                                                      
                    print-color-adjust: exact !important;                                                                                                                                                                                                              
                  }                                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                                      
              </style>                                                                                                                                                                                                                                                 
            </head>                                                                                                                                                                                                                                                    
            <body>                                                                                                                                                                                                                                                     
              ${printableTableHtml}                                                                                                                                                                                                                                    
              ${totalWeightSummaryHtml}                                                                                                                                                                                                                                
            </body>                                                                                                                                                                                                                                                    
          </html>                                                                                                                                                                                                                                                      
        `;                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                       
        printWindow.document.write(printContent);                                                                                                                                                                                                                      

        // Track loaded images                                                                                                                                                                                                                                         
        const images = printWindow.document.getElementsByTagName('img');                                                                                                                                                                                               
        const loadedImages = { current: 0 };                                                                                                                                                                                                                           
        const totalImages = images.length;                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                       
        const tryPrint = () => {                                                                                                                                                                                                                                       
          if (loadedImages.current === totalImages) {                                                                                                                                                                                                                  
            printWindow.document.close();                                                                                                                                                                                                                              
            printWindow.focus();                                                                                                                                                                                                                                       
            printWindow.print();                                                                                                                                                                                                                                       
            printWindow.close();                                                                                                                                                                                                                                       
          }                                                                                                                                                                                                                                                            
        };                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                       
        if (totalImages > 0) {                                                                                                                                                                                                                                         
          Array.from(images).forEach(img => {                                                                                                                                                                                                                          
            if (img.complete) {                                                                                                                                                                                                                                        
              loadedImages.current += 1;                                                                                                                                                                                                                               
              tryPrint();                                                                                                                                                                                                                                              
            } else {                                                                                                                                                                                                                                                   
              img.onload = () => {                                                                                                                                                                                                                                     
                loadedImages.current += 1;                                                                                                                                                                                                                             
                tryPrint();                                                                                                                                                                                                                                            
              };                                                                                                                                                                                                                                                       
              img.onerror = () => {                                                                                                                                                                                                                                    
                loadedImages.current += 1;                                                                                                                                                                                                                             
                tryPrint();                                                                                                                                                                                                                                            
              };                                                                                                                                                                                                                                                       
            }                                                                                                                                                                                                                                                          
          });                                                                                                                                                                                                                                                          
        } else {                                                                                                                                                                                                                                                       
          printWindow.document.close();                                                                                                                                                                                                                                
          printWindow.focus();                                                                                                                                                                                                                                         
          printWindow.print();                                                                                                                                                                                                                                         
          printWindow.close();                                                                                                                                                                                                                                         
        }                                                                                                                                                                                                                                                              
      } catch (error) {                                                                                                                                                                                                                                                
        console.error('Error printing table:', error);                                                                                                                                                                                                                 
        alert('Greï¿½ï¿½ka pri ispisu tablice');                                                                                                                                                                                                                           
      } finally {                                                                                                                                                                                                                                                      
        setIsPrinting(false);                                                                                                                                                                                                                                          
      }                                                                                                                                                                                                                                                                
    }, [item, items, itemsToDisplay, onPrintAll, totalWeight, dateRange, totalItems]);                                                                                                                                                                                 
                                                                                                                                                                                                                                                                       
    return (                                                                                                                                                                                                                                                           
      <>                                                                                                                                                                                                                                                               
        <PrintButton                                                                                                                                                                                                                                                   
          onClick={handlePrint}                                                                                                                                                                                                                                        
          disabled={isLoading || isPrinting || (!item && totalItems === 0)}                                                                                                                                                                                            
        >                                                                                                                                                                                                                                                              
          {isPrinting ? 'Priprema ispisa...' : 'IspiÅ¡i tablicu'}                                                                                                                                                                                                      
        </PrintButton>                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                       
        <div style={{ display: 'none' }} ref={printContainerRef}>                                                                                                                                                                                                      
          <PrintableTable items={itemsToDisplay} dateRange={dateRange} />                                                                                                                                                                                              
        </div>                                                                                                                                                                                                                                                         
      </>                                                                                                                                                                                                                                                              
    );                                                                                                                                                                                                                                                                 
  };                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                       
  export default PrintTableButton;                       
